//
//  FHSyncUtilsTest.m
//  FH
//
//  Created by Wei Li on 16/07/2013.
//  Copyright (c) 2013 FeedHenry. All rights reserved.
//


#import "FHSyncUtilsTest.h"
#import "FHSyncUtils.h"
#import "JSONKit.h"

@implementation FHSyncUtilsTest

- (void)setUp
{
  [super setUp];
}

- (void)tearDown
{
  [super tearDown];
}

- (void) testGetStorageFilePath
{
  NSString* fileName = @".test.sync.json";
  NSString* filePath = [FHSyncUtils getStorageFilePath:fileName];
  STAssertTrue([[filePath lastPathComponent] isEqualToString:fileName], @"filePath is wrong: path = %@", filePath);
}

- (void) testSaveAndLoadData
{
  NSString* fileName = @".test.sync.json";
  NSMutableDictionary* data = [NSMutableDictionary dictionary];
  [data setObject:@"test1" forKey:@"test1"];
  [data setObject:@"test2" forKey:@"test2"];
  NSError* error = nil;
  [FHSyncUtils saveData:[data JSONString] toFile:fileName error:error];
  STAssertNil(error, @"Error when saving data: %@", [error localizedDescription]);
  error = nil;
  NSString* dataContent = [FHSyncUtils loadDataFromFile:fileName error: error];
  STAssertNil(error, @"Error when loading data: %@", [error localizedDescription]);
  NSDictionary* dataLoaded = [dataContent objectFromJSONString];
  NSString* test1Data = [dataLoaded objectForKey:@"test1"];
  NSString* test2Data = [dataLoaded objectForKey:@"test2"];
  STAssertTrue([test1Data isEqualToString:@"test1"], @"test1 data match");
  STAssertTrue([test2Data isEqualToString:@"test2"], @"test2 data match");
}

- (void) testHashValue
{
  NSString* text = @"test";
  NSString* hashValue = [FHSyncUtils generateHashWithString:text];
  NSLog(@"generate hashValue is %@", hashValue);
  NSString* expected = @"a94a8fe5ccb19ba61c4c0873d391e987982fbbd3"; 
  STAssertTrue([hashValue isEqualToString:expected], @"SHA1 hash value doesn't match");
}

- (void) testGenerateHash
{
  NSMutableDictionary* data = [NSMutableDictionary dictionary];
  [data setObject:@"Test Data" forKey:@"testKey"];
  [data setObject:[NSNumber numberWithBool:YES] forKey:@"testBoolKey"];
  [data setObject:[NSNumber numberWithInt:10]  forKey:@"testNumKey"];
  NSMutableArray* array = [NSMutableArray array];
  [array addObject:@"obj1"];
  [array addObject:@"obj2"];
  [data setObject:array forKey:@"testArrayKey"];
  NSMutableDictionary * dict = [NSMutableDictionary dictionary];
  [dict setObject:@"obj3" forKey:@"obj3key" ];
  [dict setObject:@"obj4" forKey:@"obj4key" ];
  [data setObject:dict forKey:@"testDictKey"];
  NSLog(@"Data = %@", [data JSONString]);
  NSString* hashValue = [FHSyncUtils generateHashForData:data];
  NSString* expectedHashValue = @"5f4675723d658919ede35fac62fade8c6397df1d"; //This value is generated by running the generate hash function against the exactly same JSON object in the Javascript SDK
  NSLog(@"Generated hashValue is %@", hashValue);
  STAssertNotNil(hashValue, @"Hash value should not be nil");
  STAssertTrue([hashValue isEqualToString:expectedHashValue], @"Hashvalue generated by ios SDK doesn't match JS SDK. ios = %@ :: js = %@", hashValue, expectedHashValue);
}

@end
